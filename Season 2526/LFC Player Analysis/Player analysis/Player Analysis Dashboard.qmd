---
title: "Player Analysis Dashboard"
author: "Dr Phi Barter"
format: 
  dashboard:
      scrolling: true
      logo: https://anfieldindex.com/wp-content/uploads/2016/09/AI-Under-Pressure.png
      nav-buttons: 
                  - icon: github
                    href: https://github.com/Barts78
                  - icon: linkedin
                    href: https://www.linkedin.com/in/phil-barter-55500122/
                  - icon: twitter
                    href: https://twitter.com/Barts78
                  - icon: bluesky
                    href: https://bsky.app/profile/barts78.bsky.social
                    
      theme: 
        - Lux
        - Matchdash.scss
      type: default 
editor: visual
---

```{r}
#| label: Dashboard Setup
#| echo: false
#| output: false
#| warning: false
#| message: false

library(tidyverse)
library(systemfonts)
library(sysfonts)
library(fontawesome)
library(glue)
library(worldfootballR)
library(gganimate)
library(ggsoccer)
library(ggpointdensity)
library(ggthemes)
library(ggtext)
library(ggimage)
library(gt)
library(gtExtras)
library(grid)
library(ggdensity)
library(treemapify)
library(readxl)
library(writexl)
library(ggrepel)
library(png)
library(plotly)
library(reshape)
library(psych)
library(ggshakeR)
library(tidyquant)
library(gfonts)
library(extrafont)
library(extrafontdb)
library(ggnewscale)
library(stringr)
library(ggh4x)
library(ggforce)
library(scales)
library(slider)
library(rlang)

###############
#set team information
#set away
Match_Away <- paste0("All Oppo")

#Set Home
Match_Home <- paste0("Liverpool")

#set match date
Game_date <- paste("17-02-2026")

#set Game name
GameName <- paste0(Match_Home," vs ", Match_Away)

#set fixture
Match_Fixture <- paste0(Match_Home, " vs ", Match_Away, " - ", Game_date)

#set database
DataBaseName <- paste0("AllComp_LFC_Games_2526")

FACDataBaseName <- paste0("FAC_LFC_Games_2526")

EPLDataBaseName <- paste0("EPLComp_LFC_Games_2526")

CLDataBaseName <- paste0("CL_LFC_Games_2526")

LCDataBaseName <- paste0("LC_LFC_Games_2526")

######################
#set colours
#set Away color
Color_Home <- paste("#8B1A1A")

#set Away text
Color_Home_Text <- paste("white")

#set Home color
Color_Away <- paste("#1E90FF")

#set home text color
Color_Away_Text <- paste("white")

#####################
#load fonts
#set fonts
font_add("Awesome", regular = "/Library/Fonts/Font Awesome 7 Brands-Regular-400.otf")


#load season databases
fileName <- paste0("~/Documents/Dropbox files/AI LFC data/Data Sets/WhoScored/Databases/", DataBaseName, ".xlsx")
SeasonData <- read_xlsx(fileName)

#add in team group to data base
SeasonData <- SeasonData %>%
  mutate(Team_Group = ifelse(TeamName == "Liverpool", "Liverpool", "All Oppo"))

fileName <- paste0("~/Documents/Dropbox files/AI LFC data/Data Sets/WhoScored/Databases/", EPLDataBaseName, ".xlsx")
EPLSeasonData <- read_xlsx(fileName)

#add in team group to data base
EPLSeasonData <- EPLSeasonData %>%
  mutate(Team_Group = ifelse(TeamName == "Liverpool", "Liverpool", "All Oppo"))

fileName <- paste0("~/Documents/Dropbox files/AI LFC data/Data Sets/WhoScored/Databases/", CLDataBaseName, ".xlsx")
CLSeasonData <- read_xlsx(fileName)

#add in team group to data base
CLSeasonData <- CLSeasonData %>%
  mutate(Team_Group = ifelse(TeamName == "Liverpool", "Liverpool", "All Oppo"))

#set match day number
#MatchDay <- first(na.omit(plottingData$Match_day))

#ser game date
#Game_date <- first(na.omit(plottingData$Game_date))

#set man of the match
HMOM = paste("")
AMOM = paste("")


plottingData <- SeasonData 

#################################
#set color palletes

#set away color scale
#ColorScale_Home <- paste("ggsci::red_material")

#set away color scale con
#ColorScale_HomeC <- paste("ggthemes::Red")

#set home color scale
#ColorScale_Away <- paste("ggsci::green_material")

#set home color scale con
#ColorScale_AwayC <- paste("ggthemes::Green")

HomeplottingData <- plottingData %>% filter(TeamName == homeTeam)
AwayplottingData <- plottingData %>% filter(TeamName == awayTeam)


homeplayers <- sort(unique(as.character(HomeplottingData$playerId)))
awayplayers <- sort(unique(as.character(AwayplottingData$playerId)))

build_palette <- function(players,
                          team_color,
                          team_text_color = "#FFFFFF",
                          PalType = c("D", "C"),
                          n_c = 256) {
  
  PalType <- toupper(match.arg(PalType))
  players <- unique(players)
  ramp <- grDevices::colorRampPalette(c(team_text_color, team_color))
  
  if (PalType == "C") {
    # Continuous: return an actual palette vector (for gradient scales)
    return(ramp(n_c))
  }
  
  # Discrete: named vector (player -> colour)
  n <- length(players)
  if (n == 0) return(setNames(character(0), character(0)))
  if (n == 1) return(setNames(team_color, players))
  
  cols <- ramp(n)
  names(cols) <- players
  cols
}

ColorScale_HomeC <- build_palette(homeplayers, Color_Home, "#FFFAFA", "C")

ColorScale_Home <- build_palette(homeplayers, Color_Home,  "#FFFAFA", "D")

ColorScale_AwayC <- build_palette(awayplayers, Color_Away,  "#FFFAFA", "C")

ColorScale_Away <- build_palette(awayplayers, Color_Away,  "#FFFAFA", "D")

########################
#set Waves titles
WavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

AwayWavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

#set xg line titles 
xGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

AwayxGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

#set dribbles title
DribblesTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Dribbles (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set duels title
DuelsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set PPs title
PPsTitle_textHalf <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayPPsTitle_textHalf <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

PPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

AwayPPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

HomeTertiary_title <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Match  </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Possession</span><span style='color:grey12;font-size:16px;'> to </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Field Tilt</span><span style='color:gray12;font-size:16px;'> conversion</span>"))

AwayTertiary_title <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Match  </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Possession</span><span style='color:grey12;font-size:16px;'> to </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Field Tilt</span><span style='color:gray12;font-size:16px;'> conversion</span>"))

##new socials
social_caption <- function(twitter="@Barts78",
                           github = "Barts78",
                           linkedin= "Phil-barter",
                           mastodon= "@DrBarts",
                           threads = "Barts78",
                           data = "OPTA",
                           blueSky = "@barts78",
                           icon_color="black",
                           font_color="#454545",
                           bg_color="snow",
                           font_family="sans-serif"){
  
  icons = list(
    twitter = "&#xe61a",
    github = "&#xf09b",
    linkedin = "&#xf08c",
    mastodon = "&#xf4f6",
    threads = "&#xe618",
    data = "&#xf16b",
    blueSky = "&#xe671"
  )   
  
  social = list(threads = threads, linkedin = linkedin, twitter = twitter, mastodon = mastodon, github = github, blueSky = blueSky, data = data)
  social = social[!is.na(social)]
  
  caption = ""
  for (name in names(social)) {
    icon = icons[name]
    info = social[name]
    html = glue("<span style='font-family:\"Font Awesome 7 Brands\";color:{icon_color};font-size:8px;'>{icon};</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>
                <span style='font-family:{font_family};color:{font_color};font-size:8px;'>{info}</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>")
    
    
    caption = paste0(caption,html)
  }
  
  caption
}

#create social caption
my_socials <- social_caption(twitter = "@Barts78",
                             github = "Barts78",
                             linkedin = "Phil-barter",
                             mastodon = "@DrBarts",
                             threads = NA,
                             blueSky = "@barts78",
                             data = "OPTA",
                             icon_color = "#454545",
                             font_color = "#454545",
                             bg_color = "snow",
                             font_family = "sans-serif")

my_datasource <- paste0('<span style="font-family:\'Font Awesome 7 Free\', Arial, sans-serif;color:#454545;font-size:8px;">&#x1F4BE;</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>',
                        '<span style="font-family:sans-serif;color:#454545;font-size:8px;">OPTA</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>')

My_caption <- paste0(my_socials)

```

```{r}
#| label: Simulate Football Match Outcomes Based on xG
#'
#' @param home_xg_vector Numeric vector of xG values for each home team shot
#' @param away_xg_vector Numeric vector of xG values for each away team shot
#' @param runs Number of simulations to perform (default: 10000)
#' @param seed Random seed for reproducibility (default: 1111)
#'
#' @return A list containing:
#' - `prob_matrix`: A matrix of scoreline probabilities
#' - `long_prob_matrix`: Data frame for plotting with ggplot
#' - `simulation_results`: Data frame of simulated outcomes


simulate_match_outcomes <- function(
  home_xg_vector, 
  away_xg_vector, 
  runs = 10000, 
  seed = 1111,
  actual_home_goals = NULL,
  actual_away_goals = NULL
) {
  set.seed(seed)

  safe_simulate_goals <- function(xg_vector, runs) {
    # Flatten in case it's a list (like from dplyr::select)
    xg_vector <- unlist(xg_vector)

    if (length(xg_vector) == 0) return(rep(0, runs))

    # Clean and clip to [0, 1]
    xg_vector <- as.numeric(xg_vector)
    xg_vector <- xg_vector[!is.na(xg_vector)]
    xg_vector <- pmin(pmax(xg_vector, 0), 1)

    if (length(xg_vector) == 0) return(rep(0, runs))

    draws <- rbinom(length(xg_vector) * runs, size = 1, prob = rep(xg_vector, each = runs))
    goals_matrix <- matrix(draws, nrow = runs, byrow = FALSE)
    rowSums(goals_matrix)
  }

  home_goals <- safe_simulate_goals(home_xg_vector, runs)
  away_goals <- safe_simulate_goals(away_xg_vector, runs)

  simulation_results <- data.frame(Home = home_goals, Away = away_goals)
  prob_matrix <- table(simulation_results$Home, simulation_results$Away) / runs

  long_prob_matrix <- as.data.frame(as.table(prob_matrix))
  colnames(long_prob_matrix) <- c("Home", "Away", "Probability")
  long_prob_matrix <- long_prob_matrix %>%
    mutate(Probability = round(Probability * 100, 2))

  goal_summary <- NULL
  if (!is.null(actual_home_goals) && !is.null(actual_away_goals)) {
    exact_count <- sum(home_goals == actual_home_goals & away_goals == actual_away_goals)
    at_least_home <- sum(home_goals >= actual_home_goals)
    at_least_away <- sum(away_goals >= actual_away_goals)

    goal_summary <- list(
      actual_score = paste(actual_home_goals, "-", actual_away_goals),
      exact_occurrences = exact_count,
      exact_percentage = round(100 * exact_count / runs, 2),
      home_goals_at_least = at_least_home,
      away_goals_at_least = at_least_away,
      home_goals_at_least_pct = round(100 * at_least_home / runs, 2),
      away_goals_at_least_pct = round(100 * at_least_away / runs, 2)
    )
  }

  return(list(
    prob_matrix = prob_matrix,
    long_prob_matrix = long_prob_matrix,
    simulation_results = simulation_results,
    goal_summary = goal_summary
  ))
}


```

```{r}
#| label: Team season sumary function 

# Reusable function to compute team summary metrics
compute_season_summary <- function(data, group_vars) {
  data %>%
    mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0),
           TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), EPVvalue, 0),
           TeamEPV = as.numeric(TeamEPV),
           Match_day = as.numeric(Match_day)) %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(Match_day = first(Match_day),
              n_matches = n_distinct(game_name),
              across(c(Goals, In_play_time, Touches, UnSuccessful_Touches, PK_Box_Touches,
                       Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
                       Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
                       TotalShots, OFShots, Blocked_Shot, OTShots, SixYard_Box_Shots,
                       PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, 
                       Attempted_Passes,
                       Successful_Passes, 
                       UnSuccessful_Passes, 
                       Long_Passes, 
                       Successful_Long_Passes,
                       Corners, 
                       Short_Corners, 
                       Cross_Passes, 
                       Successful_Cross, 
                       UnSuccessful_Cross,
                       Tackles_Total, 
                       Tackles_Won, 
                       Tackles_Lost, 
                       Fouls_Total, 
                       Fouls_Conceeded,
                       Fouls_Received, 
                       Aerial_Won, 
                       Aerial_Lost,
                       Clearances_Total,
                       Interceptions_Total,
                       Recoverys_Total, 
                       Offside_Won, 
                       Offside_Lost, 
                       TeamEPV, 
                       Defensive_Third_Touches, 
        Middle_Third_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries,
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        MyxA,
        TeamxT,
        Aerial_total, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
),
        ~ sum(.x, na.rm = TRUE) / n_matches
      ),
      #.groups = "drop"
    ) %>%
    #select(-n_matches) %>%
    mutate(
      In_play_time = round(In_play_time / 60, 1),
      Possession   = round((Touches / (sum(Touches))) * 100, 1),
      Field_Tilt   = round((Final_Third_Touches / (sum(Final_Third_Touches))) * 100, 1),
      Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
      Long_Pass_Success = round((Successful_Long_Passes / Long_Passes) * 100, 1),
      Long_Pass_Rate    = round((Long_Passes / Attempted_Passes) * 100, 2),
      Cross_Success     = round((Successful_Cross / Cross_Passes) * 100, 2),
      Failed_Pass    = Attempted_Passes - Successful_Passes,
      Failed_Cross   = Cross_Passes - Successful_Cross,
      Failed_Dribble = Dribbles_Total - Dribbles_Won,
      Poss_Gained = Interceptions_Total + Recoverys_Total +
                    (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost),
      Poss_Lost = Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble +
                  OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost,
      Posession_Control =
        Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) +
        (Aerial_Won - Aerial_Lost) -
        (Mis_Control + Dispossessed_Total + UnSuccessful_Passes +
         UnSuccessful_Cross + Dribbles_Lost + OFShots + Blocked_Shot + Offside_Lost),
      `EPV % xG Con.`   = round((xG   / TeamEPV) * 100, 1),
      `EPV % NPxG Con.` = round((NPxG / TeamEPV) * 100, 1)
    ) %>%
    mutate(across(everything(), ~ replace_na(.x, 0))) %>%
    mutate(across(where(is.numeric), ~ round(.x, 2)))
}

```

```{r}
#| label: Team sumary function 

# Reusable function to compute team summary metrics
compute_summary <- function(data, group_vars) {
  data %>%
    mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0),
           TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), EPVvalue, 0),
           TeamEPV = as.numeric(TeamEPV)) %>%
    group_by(across(all_of(group_vars))) %>%
        summarise(Match_day = first(Match_day), 
                  across(c(Goals, In_play_time, Touches, UnSuccessful_Touches, PK_Box_Touches,
                       Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
                       Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
                       TotalShots, OFShots, Blocked_Shot, OTShots, SixYard_Box_Shots,
                       PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, 
                       Attempted_Passes,
                       Successful_Passes, 
                       UnSuccessful_Passes, 
                       Long_Passes, 
                       Successful_Long_Passes,
                       Corners, 
                       Short_Corners, 
                       Cross_Passes, 
                       Successful_Cross, 
                       UnSuccessful_Cross,
                       Tackles_Total, 
                       Tackles_Won, 
                       Tackles_Lost, 
                       Fouls_Total, 
                       Fouls_Conceeded,
                       Fouls_Received, 
                       Aerial_Won, 
                       Aerial_Lost,
                       Clearances_Total,
                       Interceptions_Total,
                       Recoverys_Total, 
                       Offside_Won, 
                       Offside_Lost, 
                       TeamEPV, 
                       Defensive_Third_Touches, 
        Middle_Third_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries,
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        MyxA,
        TeamxT,
        Aerial_total, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
        ),
                 sum, na.rm = TRUE)) %>%
    mutate(In_play_time = round(In_play_time / 60, 1),
           Possession = round((Touches/(sum(Touches)))*100,1),
           Field_Tilt = round((Final_Third_Touches/(sum(Final_Third_Touches)))*100,1),
           Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
           Long_Pass_Success = round((Successful_Long_Passes / Long_Passes) * 100, 1),
           Long_Pass_Rate = round((Long_Passes / Attempted_Passes) * 100, 2),
           Cross_Success = round((Successful_Cross / Cross_Passes) * 100, 2),
           Failed_Pass = Attempted_Passes - Successful_Passes,
           Failed_Cross = Cross_Passes - Successful_Cross,
           Failed_Dribble = Dribbles_Total - Dribbles_Won,
           Poss_Gained = Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost),
           Poss_Lost = Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost,
           Posession_Control = Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) +
                               (Aerial_Won - Aerial_Lost) -
                               (Mis_Control + Dispossessed_Total + UnSuccessful_Passes +
                               UnSuccessful_Cross + Dribbles_Lost + OFShots + Blocked_Shot + Offside_Lost),
           `EPV % xG Con.` = round((xG / TeamEPV) * 100, 1),
           `EPV % NPxG Con.` = round((NPxG / TeamEPV) * 100, 1),
           ) %>%
    
    mutate(across(everything(), ~replace_na(.x, 0))) 
  
}

```

```{r}
#| label: Shift column function
# Shift column funtion, this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

```

```{r}
#| output: false
#| label: touch area function Quantiles
#' Function for plotting Player touch areas
#' Function for plotting Team touch areas - set at 75%

#calculate touch area of player - set at 75% using quantiles
touch_area_shape_quantiles <- function(data) {
  
  x_low <- quantile(data$x, 0.15)
  x_high <- quantile(data$x, 0.85)
  
  y_low <- quantile(data$y, 0.15)
  y_high <- quantile(data$y, 0.85)
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}
```

```{r}

#| output: false
#| label: touch area function Mad
#' Function for plotting Player touch areas using 1.5 MAD( 75% of data) Mediands
touch_area_shape_mad <- function(data) {
  
  x_median <- median(data$x)
  y_median <- median(data$y)
  
  x_mad <- median(abs(data$x - x_median))/0.6745
  y_mad <- median(abs(data$y - y_median))/0.6745
  
  x_low <- x_median - 1.5*x_mad
  x_high <- x_median + 1.5*x_mad
  
  y_low <- y_median - 1.5*y_mad
  y_high <- y_median + 1.5*y_mad
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

```

```{r}
#| output: false
#| label: Enhanced TouchPlayerPlot_AI with method selection and dynamic faceting
TouchPlayerPlot_AI <- function(
  data,
  color = "firebrick4",
  text_color = "",
  title = "",
  subtitle = "",
  plot_start = 0,
  plot_finish = 45,
  logo = "",
  method = "quantile",  # or "mad"
  facet_by = "playerId"
) {
  required_cols <- c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "role")
  if (nrow(data) == 0 || !all(required_cols %in% names(data))) {
    stop("The dataset has insufficient columns and/or insufficient data.")
  }

  data <- data %>%
    filter(`type/value` %in% c(1, 2, 3, 4, 7, 8, 9, 10:16, 41, 42, 44, 45, 50, 52, 54, 61, 73, 74),
           `outcomeType/value` == 1) %>%
    drop_na(playerId, x, y) %>%
    filter(between(expandedMinute, plot_start, plot_finish))

  list_data <- split(data, data$playerId)

  # Use appropriate shape function
  shape_fn <- if (method == "mad") touch_area_shape_mad else touch_area_shape_quantiles
  touch_area_data <- purrr::map(list_data, shape_fn) %>% purrr::reduce(full_join)

  PlayerPos <- touch_area_data %>%
    group_by(playerId) %>%
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    na.omit()

  teamtitle <- paste(title, "Player Touch Areas")
  
  # --- 1) Desired role order ---------------------------------------------------
role_levels <- c("Keeper", "Defender", "Midfielder", "Attacker")
facet_col   <- sym(facet_by)        # should be "playerId" for this function

# --- 2) Build facet order from role, then name --------------------------------
# (If a player appears with multiple roles, the first by role order is taken.)
facet_levels <- data %>%
  distinct(!!facet_col, role) %>%
  mutate(role = factor(role, levels = role_levels)) %>%
  arrange(role, !!facet_col) %>%
  pull(!!facet_col) %>%
  as.character()

# keep exactly 11 panels
facet_levels <- facet_levels[seq_len(min(11, length(facet_levels)))]

# --- 3) Relevel the faceting variable in ALL datasets used in the plot --------
data <- data %>%
  mutate(!!facet_col := factor(.data[[facet_by]], levels = facet_levels)) %>%
  filter(!is.na(.data[[facet_by]]))

touch_area_data <- touch_area_data %>%
  mutate(!!facet_col := factor(.data[[facet_by]], levels = facet_levels)) %>%
  filter(!is.na(.data[[facet_by]]))

PlayerPos <- PlayerPos %>%
  mutate(!!facet_col := factor(.data[[facet_by]], levels = facet_levels)) %>%
  filter(!is.na(.data[[facet_by]]))

  player_touch_map <- ggplot(touch_area_data) +
    annotate_pitch(dimensions = pitch_opta, fill = "#DBDBDB", colour = "#454545") +
    theme_pitch() +
    annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
    annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
    
    geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey") +
    geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey") +
    geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey") +
    
    geom_point(data = data, aes(x = x, y = y), alpha = 0.5, colour = "black", size = 1) +
    geom_polygon(aes(x = x, y = y), colour = color, alpha = 0.2, fill = color, size = 0.4) +
    geom_point(data = PlayerPos, aes(x = x, y = y), colour = color, alpha = 0.8, shape = 19, size = 2) +
    facet_wrap(as.formula(paste("~", facet_by)), ncol = 4) +
    labs(
      title = teamtitle,
      x = "",
      subtitle = paste(subtitle, "
Area = 75% of activity, Team Colour Dot = Player Average Position"),
      caption = My_caption
    ) +
    theme(
      legend.position = "none",
      plot.background = element_rect(colour = "snow", fill = "snow"),
      panel.background = element_rect(colour = "snow", fill = "snow"),
      strip.background = element_rect(fill = color, color = "black", linetype = "solid", linewidth = 1),
      strip.text = element_text(size = 8, colour = text_color),
      plot.title = element_text(colour = "black", size = 14, face = "bold"),
      plot.subtitle = element_text(colour = "black", size = 10),
      plot.caption = element_markdown(),
      axis.title.x = element_blank()
    )

  if (logo == "Yes") {
    player_touch_mapAI <- ggdraw() +
      draw_plot(player_touch_map, x = 0, y = 0, width = 1, scale = 1) +
      draw_image(logo_AI, x = 0.445, y = 0.438, scale = 0.12)
  } else {
    player_touch_mapAI <- player_touch_map
  }

  return(player_touch_mapAI)
}
```

```{r}
#| output: false
#| lable: Enhanced TouchTeamPlot_OPTA with method selection
TouchTeamPlot_OPTA <- function(
  data,
  color = "#E74C3C",
  palette = NULL,
  title = "",
  subtitle = "",
  plot_start = 0,
  plot_finish = 45,
  logo = "",
  method = "mad"  # or "quantile"
) {
  required_cols <- c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "file_name", "role")
  if (nrow(data) == 0 || !all(required_cols %in% names(data))) {
    stop("The dataset has insufficient columns and/or insufficient data.")
  }

  data <- data %>%
    drop_na(playerId, x, y) %>%
    filter(dplyr::between(expandedMinute, plot_start, plot_finish))

  shape_fn <- if (method == "quantile") touch_area_shape_quantiles else touch_area_shape_mad
  list_data <- split(data, data$playerId)
  touch_area_data <- purrr::map(list_data, shape_fn) %>% purrr::reduce(dplyr::full_join)

  PlayerPos <- touch_area_data %>%
    group_by(playerId) %>%
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    tidyr::drop_na()

  # ---- NEW: build palette from `palette` or default white -> color ramp ----
  players <- sort(unique(as.character(touch_area_data$playerId)))
  n <- length(players)

  build_palette <- function(players, palette, color) {
    n <- length(players)

    # 1) Named vector mapping playerId -> color
    if (is.character(palette) && !is.null(names(palette))) {
      if (!all(players %in% names(palette))) {
        warning("Named palette does not cover all players; missing players will be auto-colored.")
      }
      cols <- palette[players]
      # fill any NAs (uncovered players) from a white->color ramp
      if (anyNA(cols)) {
        fill_cols <- grDevices::colorRampPalette(c("#FFFFFF", color))(sum(is.na(cols)))
        cols[is.na(cols)] <- fill_cols
      }
      names(cols) <- players
      return(cols)
    }

    # 2) Paletteer "pkg::pal" string
    if (is.character(palette) && length(palette) == 1 && grepl("::", palette, fixed = TRUE)) {
      if (requireNamespace("paletteer", quietly = TRUE)) {
        cols <- as.character(paletteer::paletteer_d(palette, n))
        names(cols) <- players
        return(cols)
      } else {
        warning("paletteer not installed; falling back to white -> color ramp.")
      }
    }

    # 3) Plain vector of colors to interpolate
    if (is.character(palette) && length(palette) >= 1) {
      cols <- grDevices::colorRampPalette(palette)(n)
      names(cols) <- players
      return(cols)
    }

    # Default: white -> color ramp (keeps your 'min = white' feel)
    cols <- grDevices::colorRampPalette(c("#FFFFFF", color))(n)
    if (n == 1) cols <- color
    names(cols) <- players
    cols
  }

  pal <- build_palette(players, palette, color)

  # lock factor levels
  touch_area_data <- touch_area_data %>%
    mutate(playerId = factor(as.character(playerId), levels = players))
  PlayerPos <- PlayerPos %>%
    mutate(playerId = factor(as.character(playerId), levels = players))
  # -------------------------------------------------------------------------

  teamtitle <- paste(title, "Areas")

  touch_map <- ggplot(touch_area_data) +
    
    # use the palette (discrete by player)
    scale_fill_manual(values = pal) +
    scale_colour_manual(values = pal) +

    annotate_pitch(dimensions = pitch_opta, fill = "#DBDBDB", colour = "#454545") +
    theme_pitch() +
    annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9),
             x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83),
             y = 0, yend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    #plot player touch area
    geom_polygon(aes(x = x, y = y, fill = playerId, colour = playerId), alpha = 0.15, size = 0.5) +
    #plot player average position
    geom_point(data = PlayerPos, aes(x = x, y = y, fill = playerId, colour = playerId),
               alpha = 0.7, shape = 21, size = 3, stroke = 0.5) +
    # plot player name
    geom_text(data = PlayerPos, aes(x = x, y = y + 4, label = playerId, colour = playerId), size = 3) +
    labs(
      title = teamtitle,
      subtitle = paste(subtitle, "\nArea = 75% of activity, Dot = Player Average Position"),
      caption = My_caption,
      x = ""
    ) +
    theme(
      strip.background = element_rect(fill = "#DBDBDB", 
      colour = NA), strip.text = element_text(colour = "black", size = 10), 
      plot.title = element_text(colour = "black", 
      size = 14, face = "bold"),
      plot.subtitle = element_text(colour = "black", size = 10),
      plot.caption = element_markdown(),
      axis.title.x = element_text(colour = "black", size = 12, face = "bold"),
      legend.position = "none"
    )

  if (logo == "Yes") {
    touch_mapAI <- ggdraw() +
      draw_plot(touch_map, x = 0, y = 0, width = 1, scale = 1) +
      draw_image(logo_AI, x = 0.4, y = 0.45, scale = 0.07)
  } else {
    touch_mapAI <- touch_map
  }

  return(touch_mapAI)
}

```

```{r}
#| output: false
#| label: Shot map function

#' Function for plotting shots for a team

plot_shot_AI <- function(data, type = "", teamColor = "#B22222", text_color = "", bins = 30, highlight_goals = "", average_location = "", matchFixture = "", mapName = "", mapType = "", matchDate = "", dataSource = "", logo = "", wrap = "") {
  
  # Checking data frame   
  if ((nrow(data) > 0) &&
      sum(c("minute", "X", "Y", "xG", "xGOT", "NPxG", "result", "OTShots", "player", "Game_Period") %in% names(data)) == 10) {

    # set plot names
    if (dataSource == "UnderStat") {
      
      if (mapType == "Home") {
      
        home_team <- (data$home_team[nrow(data)])
        
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "Away") {
      
        away_team <- (data$away_team[nrow(data)]) 
        
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold \";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
    
      } else if (mapType == "Player") {  
      
        last <- sub(".* ", "", data$player[nrow(data)])
        first <- sub(" .*", "", data$player[nrow(data)])
        player_name <- paste(first, last)
      
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span>><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
      
    } else if (dataSource == "FotMob") {
      if (mapType == "Home") {
        
        home_team <- (data$home_team[nrow(data)]) 
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$away_team[nrow(data)]) 
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        last <- (data$last_name[nrow(data)])
        first <- (data$first_name[nrow(data)])
        player_name <- paste(first, last)
        
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
        
    } else if (dataSource == "Opta") {
      if (mapType == "Team") {
        
       team_name <- (data$TeamName[nrow(data)]) 

        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{team_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$TeamName[nrow(data)]) 
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        player_name <- (data$playerId[nrow(data)])
        
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
    }
      
    fixture_name <- paste(matchFixture, "(",dataSource,")")
  

    # set Plot Colours and scale
    fill_b <- "#DBDBDB"
    pitch_lines <- "black"
    color_b <- teamColor
    colorLine <- "#95A5A6"
    colorText <- "black"
    fill_Goal <- c("No Goal" = fill_b,"SoT" = teamColor, "Goal" = teamColor)
    Alpha_Goal <- c("No Goal" = 0.9,"SoT" = 0.3, "Goal" = 1)
    # Data Wrangling 
    if (dataSource == "UnderStat") {
      data <- data %>%
        mutate(X = 100 * X) %>%
        mutate(Y = 100 * Y)
      
     } else if (dataSource == "FotMob") {
        data <- data %>%
             mutate(X = (X * 0.941050375),
                    Y = (Y * 1.464079972))
        
     } else if (dataSource == "Opta") {
        data <- data 
      }
    
    if (nrow(data) >= 1) {
      data <- data %>%
        mutate(xG = round(xG,2),
               isGoal = ifelse(result == "Goal", "Goal", ifelse(OTShots == 1, "SoT", "No Goal"))) 

              # set the pitch up
              plot <- data %>%
                ggplot() +
                annotate_pitch(dimensions = pitch_opta, colour = pitch_lines, fill = fill_b) +
                theme_pitch() +
                annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
                annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +

                
                # add zone numbers
                geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE)
              
              # geometrics 
              if (average_location == TRUE || average_location == "") {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") { ## Don't highlight goals ----
                    plot  <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute,"\nOutcome:", result, "\nxG", xG, "\nxGOT", xGOT)), alpha = 0.7, stroke = 0.5) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = "",
                      )
                  } else if (highlight_goals == TRUE) { ## Highlight goals ----
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, fill = isGoal, alpha = isGoal, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result, "\nxG", xG, "\nxGOT", xGOT)), color = color_b, shape = 21, stroke = 0.5) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_alpha_manual(values = Alpha_Goal)+
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") { ## DENSITY ----
                  plot <- plot +
                      stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
                    scale_fill_gradient(high = teamColor, low = text_color) +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5)
                  
                } else if (type == "hexbin") { ## HEXBIN ----
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result,  "\nxG", xG, "\nxGOT", xGOT)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                    labs(
                      fill = "Count of Shots"
                    )
                }
              } else if (average_location == FALSE) {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") {
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result, "\nxG", xG, "\nxGOT", xGOT)), alpha = 0.7, stroke = 0.5) +
                      geom_image(data = filter(data, isGoal == "Goal"),
    mapping = aes(x = X, y = Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball3.png"), 
     by = "width", inherit.aes = TRUE
  ) +
                      
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } else if (highlight_goals == TRUE) {
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, fill = isGoal, alpha = isGoal, text = paste("Player:", player, "\nMin:", minute,  "\nOutcome:", result,  "\nxG", xG, "\nxGOT", xGOT)), color = color_b, shape = 21,  stroke = 0.5) +
                      
                      geom_image(data = filter(data, isGoal == "Goal"),
    mapping = aes(x = X, y = Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball3.png"),
    by = "width", inherit.aes = TRUE
  ) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_alpha_manual(values = Alpha_Goal) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") {
                  plot <- plot +
                    stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
                    scale_fill_gradient(high = teamColor, low = text_color) +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(fill = "xG")
                  
                  
                } else if (type == "hexbin") {
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result,  "\nxG", xG, "\nxGOT", xGOT)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(
                      fill = "Count of Shots")
                } 
              }
              # Make Half pitch  
              plot <- plot +
                coord_flip(xlim = c(50, 100),
                           ylim = c(100, 0)) +
              scale_y_reverse()
              
              # formatting  
              plot <- plot +
                labs(title = shot_map_name, 
                     subtitle = fixture_name,
                     caption = My_caption) +
                
                theme(legend.position = "none",
                      legend.direction = "horizontal",
                      legend.background = element_rect(fill = "snow"),
                      legend.title = element_text(colour = colorText, face = "bold"),
                      legend.text = element_text(colour = colorText, size = 10),
                      legend.key = element_rect(fill = "snow"),
                      plot.title = element_markdown(),
                      plot.caption = element_markdown(),
                      plot.background = element_rect(colour = "snow", fill = "snow"),
                      panel.background = element_rect(colour = "snow", fill = "snow"),
                      plot.subtitle = element_text(colour = colorText, hjust = 0, size = 10))
              
              # wrap or not
              if (wrap == "Player") 
                {
                #divide stats by player
                player_stats <- data %>%
                  group_by(player) %>%
                  summarize(
                    total_xG = sum(xG),
                    total_goal = sum(result == "Goal"),
                    xg_sot = total_xG / n(),
                    total_shots = n(),
                    SOT = sum(OTShots)
                  )

                plot <- plot +
                  facet_wrap(~player) +
                  theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                        strip.text = element_text(size = 10, colour = text_color))
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                
                } else if (wrap == "Time") {
                  
                  #divide stats by time period
                  GPeriod_stats <- data %>%
                    group_by(Game_Period) %>%
                    summarize(
                      total_xG = sum(xG),
                      total_goal = sum(result == "Goal"),
                      xg_sot = total_xG / n(),
                      total_shots = n(),
                      SOT = sum(OTShots)
                    )
                  
                  
                    plot <- plot +
                      
                      facet_wrap(~ Game_Period) +
                      theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                            strip.text = element_text(size = 10, colour = text_color)) 
                    
                    plot <- plot +
                    geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                  
              } else if (wrap == "") {
                total_xG <- sum(data$xG)
                total_goal <- sum(data$result == "Goal")
                xg_sot <- total_xG / nrow(data)
                total_shots <- nrow(data)
                SOT <- sum(data$OTShots)
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 89.45, label = format(round(total_xG, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 89.45, label = "Total xG", color = colorText, size = 3) +
                  geom_point(x = 54, y = 71.05, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 71.05, label = format(round(SOT, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 71.05, label = "SOT", color = colorText, size = 3) +
                  geom_point(x = 54, y = 50, size = 12, color = pitch_lines, shape = 21, fill = fill_b, stroke = 0.5) +
                  
                  geom_text(x = 54, y = 50, label = format(round(total_shots, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 50, label = "Total Shots", color = colorText, size = 3) +  
                  geom_point(x = 54, y = 28.95, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 28.95, label = format(round(xg_sot, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 28.95, label = "xG/Shot", color = colorText, size = 3) +
                  geom_point(x = 54, y = 10.55, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 10.55, label = format(round(total_goal, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 10.55, label = "Goals", color = colorText, size = 3)
              
                Finalplot <- plot
              }
              
              # logo or not
              if (logo == "Yes") {
                
                # annotate plot
                Finalplot <- ggdraw() +
                  draw_plot(plot, x = 0, y = 0, width = 1, height = , scale = 1) +
                  draw_image(logo_AI,  x = 0.42, y = 0.45, scale = 0.07) 
                
              } else if (logo == "") {
                
                Finalplot <- plot
              }
              
              return(Finalplot)
              
             } else 
               {
              ## add WARNING that there were no rows in the data frame passed into function??
              return(plot)
    }
    }
  }

```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: Pass network plotting function

plot_passnet_AI <- function(data, 
                            team_name, 
                            scale_stat = "EPV",
                            scale_color = "firebrick2", 
                            text_color = "white", 
                            subtitle = "", 
                            plot_start = "00", 
                            plot_finish = "45", 
                            logo = "", 
                            pitch = "", 
                            wrap = "", 
                            pressmap = "", 
                            passes = "2", 
                            Facet_by = "Game_Period") {
  
  # ---- set up dynamic facet column
  facet_col <- rlang::sym(Facet_by)
  passes    <- as.numeric(passes)
  
    # Checking data frame 
    
    if ((nrow(data) > 0) &&
        sum(c("x", "y", "finalX", "finalY", "TeamName", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "Game_Quarter", "player_shirt", "Successful_Passes") %in% names(data)) == 13) {
    } else {
      print(c("x", "y", "finalX", "finalY", "TeamName", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "Game_Quarter", "player_shirt", "Successful_Passes"))
      stop("The dataset has insufficient columns and/or insufficient data.")
    }
    
    # Generate error messages
    
    if (is.character(data$playerId) == FALSE) {
      stop("The playerId column is supposed to contain player names.")
    }
    
    if (is.character(data$TeamName) == FALSE) {
      stop("The TeamName column is supposed to contain team names.")
    }
  
    # full Pitch or half Pitch

    if  (pitch == "Half") { 
      data <- data %>%
        filter(x >= 50)
    
    }else if (pitch == "Full") {
      data <- data
    }
  # exclude set pieces and throw ins
  Pass_data <- data %>%
    filter(Attempted_Passes == 1)

      # Stat calculation
    
    if (scale_stat == "xT") {
      
      df <- Pass_data %>%
        calculate_threat(type = "opta")
      
      df <- df %>%
        mutate(xT = xTEnd - xTStart) %>%
        select(xT)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$xT
      
      leg_title <- "xT"
      
    } else if (scale_stat == "EPV") {
      
      df <- Pass_data %>%
        calculate_epv(type = "opta")
      
      df <- df %>%
        mutate(EPV = EPVEnd - EPVStart) %>%
        select(EPV)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$EPV
      
      leg_title <- "EPV"
      
    }
    
  # Calculate Pass percentage
  Pass_data <- Pass_data %>%
  replace_na(list(Attempted_Passes = 0, Successful_Passes = 0)) %>%
  mutate(stat = as.numeric(stat)) %>%
 replace_na(list(stat = 0))

  Pass_data <- Pass_data %>%
  mutate(Pass_Suc = if_else(Attempted_Passes > 0,
                                   Successful_Passes / Attempted_Passes, NA_real_))
  
  #set title text
    PassNetTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network</span>"))
  
  PassNetTitle_textD <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network & </span><span style='font-family:\"Arial\";color:gray12;font-size:14px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:14px;'>Unsuccessful</span><span style='color:gray12;font-size:14px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:14px;'>Successful</span><span style='color:gray12;font-size:14px;'>)</span>"))
  
    # wrap or not
    if (wrap == "Yes") {

      #calculate pressing date

if (pressmap == "Yes") {
  PressData <- data %>%
    filter(TeamName == team_name, Defensive_Action == 1)
}

plotCaption <- paste0(
  glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line = </span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes</span>"))

# ---- Data wrangling --------------------------------------------------------

# If you still want the "receiver" column by next event within period:

data1 <- Pass_data %>%
  filter(TeamName == team_name, !is.na(playerId)) %>%
  arrange(!!facet_col, expandedMinute) %>%
  group_by(!!facet_col) %>%
  mutate(receiver = dplyr::lead(playerId, n = 1)) %>%
  ungroup()


# ---- Nodes: player averages per chosen facet -----------------------
nodes <- data1 %>% 
  group_by(playerId, player_shirt, !!facet_col) %>% 
  summarise(
    x = mean(x, na.rm = TRUE),
    y = mean(y, na.rm = TRUE),
    events = dplyr::n(),
    stat   = sum(stat, na.rm = TRUE),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"
  )

# ---- Edgelist: successful passes per Facet choice ------------------
edgelist <- data1 %>%
  filter(Successful_Passes == 1) %>%
  select(from = playerId, to = receiver, !!facet_col) %>%
  filter(!is.na(to)) %>%
  group_by(from, to, !!facet_col) %>%
  summarise(n = dplyr::n(), .groups = "drop")

# ---- Coordinates for pass lines connections-----------------
coords <- nodes %>%
  select(playerId, !!facet_col, x, y)

# Join coords for 'from' and 'to' WITH chosen facet
edges <- edgelist %>%
  left_join(coords, by = join_by(from == playerId, !!facet_col)) %>%
  left_join(coords, by = join_by(to   == playerId, !!facet_col),
            suffix = c("", ".to")) %>%
  mutate(xend = x.to, yend = y.to) %>%
  mutate(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
  group_by(player1, player2, !!facet_col) %>%
  summarise(
    Total_Passes = sum(n, na.rm = TRUE),
    x    = dplyr::first(x),
    y    = dplyr::first(y),
    xend = dplyr::first(xend),
    yend = dplyr::first(yend),
    .groups = "drop"
  ) %>%
  filter(Total_Passes >= passes)

# ---- Final tidy on nodes ---------------------------------------------------
nodes <- nodes %>%
  arrange(!!facet_col) %>%
  mutate(
    playerId        = ifelse(grepl(" ", playerId), sub(".*\\s", "", playerId), playerId),
    playerId_short  = if_else(grepl(" ", playerId), sub(".*\\s", "", playerId), playerId)
  )

# Plot the passnetwork
      
      plot_passnet <- ggplot() +
        
        #setup the pitch
        annotate_pitch(dimensions = pitch_opta, fill = "#DBDBDB", colour = "#95A5A6") +
        theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        
        #set scale and color gradient
        scale_colour_gradientn(
          colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
        
        scale_size_continuous(range = c(0.5, 3)) +
        
        scale_fill_manual(values = c("#0000FF",  "red2"))
      
      if (pressmap == "Yes") {
        
        #plot pressing data
        plot_passnet <- plot_passnet +
          geom_point(
  data = PressData, aes(x = x, y = y, fill = outcome), shape = 21, size = 1, show.legend = FALSE)
        
      } else if (pressmap == "") {
        
        plot_passnet <- plot_passnet
      }
      
        #plot player connections
        plot_passnet <- plot_passnet +
          geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, linewidth = (Total_Passes*0.25)), colour = "black", alpha = 0.8, show.legend = FALSE) +

        #plot player positions
          new_scale_color() +
          new_scale_fill() +
          geom_point(data = nodes, aes(x, y, fill = stat), size = 3, shape = 21, colour = "black", stroke = 0.5) +

        #plot player Numbers
        geom_text(data = nodes, aes(x, y, label = player_shirt), colour = "black", size = 1) +
        
        # set scale and colors

      scale_colour_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)),
        breaks = c(0, .25, .5, .75, 1),
        labels = scales::label_percent(accuracy = 1),
        name   = "Line Color = Passing Success") +  
          
        scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
        
        #formatting
          labs(title = PassNetTitle_text,
               subtitle = plotCaption,
             x = "",
             colour = leg_title,
             caption = My_caption) +
          
            theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            axis.title.x = element_blank()) +

        #Wrap the plots
          facet_wrap(as.formula(paste("~", Facet_by)), ncol = 4) +
          theme(strip.text.x = element_text(face = "bold", size = 10, colour = text_color),
              strip.background.x = element_rect(fill = scale_color, color = "black", linetype = "solid", linewidth = 1))

    } else if (wrap == "") {
      
      #calculate pressing date
      
      if (pressmap == "Yes") {
        
        data <- data %>%
          filter(between(expandedMinute, plot_start, plot_finish))
        
        PressData <- data %>%
          filter(TeamName == team_name) 
        
        PressData <- PressData %>%
          filter(Defensive_Action == 1)

      } else if (pressmap == "") {
        
      }
      
      plotCaption <- paste0(
  glue("
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span><br>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>Line = </span>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes, Larger Circle = More Passes</span>"))

            
            plotTag <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span"))
            
            plotExplaination <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line =  </span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Darker Circle Colour = Higher Threat (EPV)</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;', Darker Line = Higher Pass Completion, Direction of Attack Right to Left</span>"))

# Data Wrangling 
      
# Team + valid IDs
data1 <- Pass_data %>%
  dplyr::filter(TeamName == team_name) %>%
  dplyr::filter(!is.na(playerId))

# Create Receiver data
  data1 <- data1 %>%
  mutate(receiver = dplyr::lead(playerId, n = 1))

# Restrict time window (ensure plot_start/finish are numeric)
data1 <- data1 %>%
  dplyr::filter(dplyr::between(expandedMinute, as.numeric(plot_start), as.numeric(plot_finish)))

# Nodes (per player)
nodes <- data1 %>%
  dplyr::group_by(playerId, player_shirt) %>%
  dplyr::summarise(
    x = mean(x, na.rm = TRUE),
    y = mean(y, na.rm = TRUE),
    events = dplyr::n(),
    stat   = sum(stat, na.rm = TRUE),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"
  )

# Edgelist (successful passes between players)
edgelist <- data1 %>%
  dplyr::filter(Successful_Passes == 1) %>%
  dplyr::select(from = playerId, to = receiver) %>%
  dplyr::group_by(from, to) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%  
  tidyr::drop_na()

# Join coordinates
coords <- nodes %>% dplyr::ungroup() %>% dplyr::select(playerId, x, y)

edges <- edgelist %>%
  dplyr::left_join(coords, by = c("from" = "playerId")) %>%
  dplyr::rename(x = x, y = y) %>%
  dplyr::left_join(coords, by = c("to"   = "playerId"), suffix = c("", ".to")) %>%
  dplyr::rename(xend = x.to, yend = y.to)

# Collapse to undirected pairs
edges <- edges %>%
  dplyr::mutate(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
  dplyr::group_by(player1, player2) %>%
  dplyr::summarise(
    Total_Passes = sum(n, na.rm = TRUE),
    x    = dplyr::first(x),
    y    = dplyr::first(y),
    xend = dplyr::first(xend),
    yend = dplyr::first(yend),
    .groups = "drop"                         
  ) %>%
  dplyr::filter(Total_Passes >= passes)

# Pass % per connection
PassStats <- data1 %>%
  dplyr::select(player1 = playerId, player2 = receiver,
                Successful_Passes, Attempted_Passes) %>%
  dplyr::group_by(player1, player2) %>%
  dplyr::summarise(
    n = dplyr::n(),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"                
  ) %>%
  tidyr::drop_na() %>%
  dplyr::mutate(Pass_Suc = dplyr::if_else(Attempted_Passes > 0,
                                          Successful_Passes / Attempted_Passes, NA_real_)) %>%
  tidyr::replace_na(list(Pass_Suc = 0))

edges <- edges %>%
  dplyr::left_join(PassStats %>% dplyr::select(player1, player2, Pass_Suc),
                   by = c("player1", "player2")) %>%
  tidyr::replace_na(list(Pass_Suc = 1))

# Final tidy on nodes
nodes <- nodes %>%
  dplyr::arrange(events) %>%
  dplyr::mutate(
    playerId_short = dplyr::if_else(grepl(" ", playerId),
                                    sub(".*\\s", "", playerId),
                                    playerId)
  )

      #set range for text to change on player circle
      EPVRange <- (max(nodes$stat)) * 0.7
      
      # Plot

    plot_passnet <- ggplot() +
      
      #setup the pitch
      annotate_pitch(dimensions = pitch_opta, fill = "#DBDBDB", colour = "#95A5A6") +
      theme_pitch() +
      annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
      annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
      
      # add zone numbers
      geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
      
      #set scale and color gradient
      scale_fill_manual(values = c("#0000FF",  "red2"), labels = c("Won", "Lost"), name = "")

      
    if (pressmap == "Yes") {
      
      #plot pressing data
      plot_passnet <- plot_passnet +
        geom_point(data = PressData, aes(x = x, y = y, fill = outcome), shape = 21, size = 1.5, stroke = 0.5, show.legend = FALSE)

    } else if (pressmap == "") {
     
      plot_passnet <- plot_passnet
      
    }
      
      #plot player connections
    plot_passnet <- plot_passnet +
      new_scale_fill() +
      
      geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, linewidth = (Total_Passes*0.25), colour = Pass_Suc)) +
      guides(linewidth = "none") +

      #plot player positions
      geom_point(data = nodes, aes(x, y, fill = stat, size = Attempted_Passes), shape = 21, colour = "black", stroke = 0.5) +
      
      # set colour
      scale_colour_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)),
        breaks = c(0, .25, .5, .75, 1),
        labels = scales::label_percent(accuracy = 1),
        name   = "Line Color = Passing Success") +
      
      scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
      
      # set scale
      scale_size_continuous(range = c(2, 10),
                        name = "Attempted Passes",
        guide = "none")
      
      plot_passnet <- plot_passnet +
      new_scale_color() +
      
      #plot player Numbers
      geom_text(data = nodes,
          aes(x, y, label = player_shirt,
              color = stat > EPVRange,
              size = Successful_Passes/4),
          show.legend = FALSE) +
      
      # set scale    
      scale_color_manual(values = c("TRUE" = "white", "FALSE" = "black"), guide = "none") +
      
      #formatting
      labs(title = PassNetTitle_text,
           subtitle = plotCaption,
           #tag = plotTag,
           x = "",
           colour = leg_title,
           caption = My_caption) +
      theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.tag = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            axis.title.x = element_blank())
    }
    
    # If half pitch
    
    if (pitch == "Half") {
      
      plot_passnet <- plot_passnet +
        coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
        scale_y_reverse() +
        labs(y = " ") +
        theme(axis.title.y = element_blank(),
              axis.title.x = element_blank())
      
    } else if (pitch == "Full") {
      
      plot_passnet <- plot_passnet
      
    }
    
    # Press or not formatting
    
    if (pressmap == "Yes") {
      
      plot_passnet <- plot_passnet +

        #formatting
        labs(title = PassNetTitle_textD,
             x = "",
             colour = leg_title)
      
    } else if (pressmap == "") {
      
      plot_passnet <- plot_passnet
    }

    # logo or not
  
    if (logo == "Yes") {
    
    # annotate plot
    Finalplot_passnet <- plot_passnet +
    annotation_custom(AI_Logo, xmin = 90, xmax = 100, ymin = 105, ymax = 115) +
      coord_cartesian(clip = "off") +
      theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    
    } else if (logo == "") {
      
      Finalplot_passnet <- plot_passnet +
        theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    }

  return(Finalplot_passnet)
  #return(list(plot = Finalplot_passnet, nodes = nodes, edges = edges))

}
```

```{r}
#| output: false
#| label: set Summary values
#| message: false
#| warning: false

#set summary values
Total_EPV <- sum(plottingData$Cumalative_EPV)
GameTime <- max(plottingData$expandedMinute)
OutofPlayTime <- round(sum(plottingData$Out_of_play_time)/60,2)
InPlayTime <- round(sum(plottingData$In_play_time)/60,2)
Possession <- round(sum(plottingData$Touches),2)
HomePossession <- round((((sum(plottingData$Touches == 1 & plottingData$TeamName == Match_Home))/Possession)*100),2)
AwayPossession <- round((((sum(plottingData$Touches == 1 & plottingData$TeamName == Match_Away))/Possession)*100),2)
HomeEPV <- round(sum(plottingData$EPVvalue[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPV <- round(sum(plottingData$EPVvalue[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomeEPVA <- round(sum(plottingData$TeamEPV[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPVA <- round(sum(plottingData$TeamEPV[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexT <- round(sum(plottingData$xTvalue[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayxT <- round(sum(plottingData$xTvalue[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexTA <- round(sum(plottingData$TeamxT[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayxTA <- round(sum(plottingData$TeamxT[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexG <- round(sum(plottingData$xG[plottingData$TeamName == Match_Home]),2)
AwayxG <- round(sum(plottingData$xG[plottingData$TeamName == Match_Away]),2)
HomeNPxG <- round(sum(plottingData$NPxG[plottingData$TeamName == Match_Home]),2)
AwayNPxG <- round(sum(plottingData$NPxG[plottingData$TeamName == Match_Away]),2)
HomeBCs <- round(sum(plottingData$BCs[plottingData$TeamName == Match_Home]),0)
AwayBCs <- round(sum(plottingData$BCs[plottingData$TeamName == Match_Away]),0)
Final_Third_Possession <- round(sum(plottingData$Final_Third_Touches),2)
HomeFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$TeamName == Match_Home))/Final_Third_Possession)*100),2)
AwayFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$TeamName == Match_Away))/Final_Third_Possession)*100),2)
HomeDActions <- round(sum(plottingData$Defensive_Action[plottingData$TeamName == Match_Home]),0)
AwayDActions <- round(sum(plottingData$Defensive_Action[plottingData$TeamName == Match_Away]),0)
HomePasses <- round(sum(plottingData$Attempted_Passes[plottingData$TeamName == Match_Home]),0)
AwayPasses <- round(sum(plottingData$Attempted_Passes[plottingData$TeamName == Match_Away]),0)
HomePPDA <- round(sum(AwayPasses/HomeDActions),2)
AwayPPDA <- round(sum(HomePasses/AwayDActions),2)
HomeEPVCon <- round(sum(HomexG/HomeEPVA),2)
AwayEPVCon <- round(sum(AwayxG/AwayEPVA),2)
HomeProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$TeamName == Match_Home]),2)
AwayProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$TeamName == Match_Away]),2)
HomeCarries <- round(sum(plottingData$Successful_Carries[plottingData$TeamName == Match_Home]),2)
HomeProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$TeamName == Match_Home]),2)
AwayCarries <- round(sum(plottingData$Successful_Carries[plottingData$TeamName == Match_Away]),2)
AwayProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$TeamName == Match_Away]),2)
HomeGoals <- round(sum(plottingData$Home_Goals),0)
HomeSOT <- round(sum(plottingData$OTShots[plottingData$TeamName == Match_Home]),0)
HomeShootingP <- round(sum(HomeGoals/HomeSOT), 2)
AwayGoals <- round(sum(plottingData$Away_Goals),0)
AwaySOT <- round(sum(plottingData$OTShots[plottingData$TeamName == Match_Away]),0)
AwayShootingP <- round(sum(AwayGoals/AwaySOT), 2)
HomePPDO <- round(sum(HomeShootingP + (1 - AwayShootingP))*1000, 0)
AwayPPDO <- round(sum(AwayShootingP + (1 - HomeShootingP))*1000, 0)

#prepare first sub time data (min before sub)
firstSubHome <- plottingData %>%
  filter(TeamName == Match_Home, SubTime != 0) %>%
  summarise(firstsubhome = min(SubTime)) %>%
  pull(firstsubhome)

firstSubAway <- plottingData %>%
  filter(TeamName == Match_Away, SubTime != 0) %>%
  summarise(firstsubaway = min(SubTime)) %>%
  pull(firstsubaway)

#first goal
plottingData <- plottingData %>%
  mutate(First_goal = if_else(`type/value` == 16, as.numeric(expandedMinute), NA_real_)) %>%
  mutate(First_goal = min(First_goal, na.rm = TRUE))

First_Goal <- first(na.omit(plottingData$First_goal))


# set-up data frame from main variables above for summary tables
PPDOTable <- data.frame(TeamName = c(Match_Home, Match_Away),
                         PPDO = c(HomePPDO, AwayPPDO))

plottingData <- plottingData %>%
  mutate('Game_Quarter' = ifelse(minute < 26 & period == 1, "1st Quarter",
                                ifelse(minute < 51 & minute > 25 & period == 1, "2nd Quarter",
                                       ifelse(minute < 71 & minute > 50 & period == 2, "3rd Quarter",
                                              ifelse(minute < 100 & minute > 70 & period == 2, "4th Quarter", "Injury Time")))))

```

# All Competitions

```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: player Season stats tables setup

PlayerMatchRole <- SeasonData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = if_else(`outcomeType/value` == 1, as.numeric(EPVvalue), 0)
  ) %>%
  group_by(TeamName, playerId, role, player_shirt, game_name) %>%
  summarise(
    minutes_played = min(minutes_played, na.rm = TRUE),
    across(
      c(Goals, TotalShots, OFShots, SoT = OTShots, Out_Box_Shots, Touches,
        Defensive_Third_Touches, Middle_Third_Touches, Final_Third_Touches,
        PK_Box_Touches, SixYard_Box_Touches, Attempted_Carries, Successful_Carries,
        Prog_Carries, Final_Third_Carries, Attempted_Passes, Successful_Passes,
        Long_Passes, Final_Third_Passes, PK_Box_Passes, Prog_Passes, Key_Passes,
        Assists, BCs, TeamEPV, xG, xGOT, MyxA, TeamxT, Aerial_total, Aerial_Won,
        Aerial_Lost, Ground_Duels_Total, Ground_Duels_Won, Ground_Duels_Lost,
        UnSuccessful_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
        Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
        Blocked_Shot, SixYard_Box_Shots, PK_Box_Shots, NPxG, UnSuccessful_Passes,
        Successful_Long_Passes, Corners, Short_Corners, Cross_Passes, Successful_Cross,
        UnSuccessful_Cross, Tackles_Total, Tackles_Won, Tackles_Lost, Fouls_Total,
        Fouls_Conceeded, Fouls_Received, Interceptions_Total, Recoverys_Total,
        Clearances_Total, Offside_Won, Offside_Lost, Carries_distance,
        Successful_Carries_Distance, Prog_Carries_Distance),
      ~ sum(.x, na.rm = TRUE)
    ),
    .groups = "drop"
  )

MatchSummaryPLayerSeasonData <- PlayerMatchRole %>%
  group_by(TeamName, playerId, role, player_shirt) %>%
  summarise(
    Matches_Played = n_distinct(game_name),
    minutes_played = sum(minutes_played, na.rm = TRUE),

    across(
      -c(game_name, Matches_Played, minutes_played),
      ~ sum(.x, na.rm = TRUE)
    ),

    .groups = "drop"
  )

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  group_by(TeamName) %>%
  mutate(
    Team_TotalTouches  = sum(Touches, na.rm = TRUE),
    Team_TotalEPV      = sum(TeamEPV, na.rm = TRUE),
    Team_TotalxG       = sum(xG, na.rm = TRUE),
    Team_TotalPasses   = sum(Attempted_Passes, na.rm = TRUE),
    Team_TotalDuels    = sum(Ground_Duels_Total, na.rm = TRUE),
    Team_TotalAerials  = sum(Aerial_total, na.rm = TRUE),
    Team_TotalShots    = sum(TotalShots, na.rm = TRUE),

    Possession   = round(Touches / Team_TotalTouches, 2),
    Pass_Success = round(Successful_Passes / Attempted_Passes, 2),
    Aerial_Success = Aerial_Won / Aerial_total,
    Duel_Success   = Ground_Duels_Won / Ground_Duels_Total,

    On_Ball_Time = round(InPlayTime * Possession, 2),

    Team_EPV_P    = round(TeamEPV / Team_TotalEPV, 2),
    Team_xG_P     = round(xG / Team_TotalxG, 2),
    Team_Duels_P  = round(Ground_Duels_Total / Team_TotalDuels, 2),
    Team_Aerial_P = round(Aerial_total / Team_TotalAerials, 2),
    Team_Passes_P = round(Attempted_Passes / Team_TotalPasses, 2),
    Team_Shots_P  = round(TotalShots / Team_TotalShots, 2)
  ) %>%
  mutate(
    across(c(Aerial_Success, Duel_Success, Pass_Success), ~ replace_na(.x, 0))
  ) %>%
  ungroup()

MD_adv_passing <- SeasonData 
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "playerId", new_names = "Receiver", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "TeamName", new_names = "Receiver_Team", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "player_shirt", new_names = "Receiver_shirt", len = 1, up = TRUE)

MD_adv_passing <- MD_adv_passing %>%
  filter(Attempted_Passes == 1) %>% 
  select(Receiver, Receiver_shirt, Passer_Team = TeamName, Receiver_Team, minutes_played, Attempted_Passes, Successful_Passes, Key_Passes, Prog_Passes, EPV = EPVvalue) 

MD_adv_passing <- MD_adv_passing %>%
  group_by(Receiver, Receiver_Team) %>%
    summarise(Receiver_shirt = first(Receiver_shirt), Passes_Recieved = sum(Attempted_Passes), Successful_Recieved = sum(Successful_Passes), Key_Passes_Recieved = sum(Key_Passes), Prog_Passes_Recieved = sum(Prog_Passes), EPV = sum(EPV))  %>% 
  #na.omit() %>%
  mutate(receiving_Suc = (Successful_Recieved / Passes_Recieved)) %>%
  replace_na(list(receiving_Suc = 0)) %>%
  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, EPV_Recieved = EPV, receiving_Suc)

#data load check for data to be converted to number
#MatchdayTablePass <- MD_passing_values #xt xa from fbref
MatchdayTableAdvPass <- MD_adv_passing

# add all data together
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(MatchdayTableAdvPass, by = c("TeamName" = "Team", "player_shirt" = "Shirt", "playerId" = "Receiver"), copy = TRUE) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

#work out detailed passing, and touches variables
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  mutate('xG/Shot' =  xG/TotalShots,
  'Shot Accuracy' = SoT/TotalShots,
  'Shot Quality' = (xGOT - xG)/xG) %>%
  mutate(`% F 3rd Carries` = Final_Third_Carries / Successful_Carries) %>%
  mutate(`% P Carries` = Prog_Carries / Successful_Carries) %>%
  mutate(`% Carries D Prog` = Prog_Carries_Distance / Successful_Carries_Distance) %>%
  mutate(`Def Third Touches / Min` = Defensive_Third_Touches / minutes_played) %>%
  mutate(`Mid Third Touches / Min` = Middle_Third_Touches / minutes_played) %>%
  mutate(`F 3rd Touches / Min` = Final_Third_Touches / minutes_played) %>%
  mutate(`PK Box Touches / Min` = PK_Box_Touches / minutes_played) %>%
  mutate(`% T D Third` = Defensive_Third_Touches / Touches) %>%
  mutate(`% T M Third` = Middle_Third_Touches / Touches) %>%
  mutate(`% T F 3rd` = Final_Third_Touches / Touches) %>%
  mutate(`% T PK Box` = PK_Box_Touches / Touches) %>%
  mutate(`T / Min` = Touches / minutes_played) %>%
  mutate(Failed_Pass = round(Attempted_Passes - Successful_Passes, 2),
         Failed_Cross = round(Cross_Passes - Successful_Cross, 2),
         Failed_Dribble = round(Dribbles_Total - Dribbles_Won, 2),
         Poss_Gained = round(Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost), 2),
         Poss_Lost = (Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost),
         Posession_Control = (Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost) - (Mis_Control + Dispossessed_Total + UnSuccessful_Passes + UnSuccessful_Cross + Dribbles_Lost  + OFShots + Blocked_Shot + Offside_Lost)),) %>%
  mutate_all(~ ifelse(is.na(.), 0, .))

DefEPVData <- SeasonData %>%
  filter(Corners == 0,
         Short_Corners == 0,
         FreeKicks == 0,
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 107,
           `type/value` == 1 |
           `type/value` == 2 | 
           `type/value` == 3 |
           `type/value` == 4 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "EPV_Def", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(TeamName, playerId, EPVvalue, Defensive_Action, `outcomeType/value`, EPV_Def, role) %>%
  mutate(EPV_Faced = (EPVvalue + EPV_Def),
    Successful_Def_EPV = ifelse(`outcomeType/value` == 1, paste0(EPV_Faced), 0),
         Unsuccessful_Def_EPV = ifelse(`outcomeType/value` == 0, paste0(EPV_Faced), 0), 
         Successful_Def_EPV = as.numeric(Successful_Def_EPV),
         Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

DefEPVData <- DefEPVData %>%
    group_by(playerId, role, TeamName) %>% 
  summarise(EPV_Faced = sum(EPV_Faced),
            EPV_Won = sum(Successful_Def_EPV/EPV_Faced), 
            EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .)) 

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(DefEPVData, by = c('playerId' = 'playerId', 'TeamName' = 'TeamName', 'role' = 'role'), copy = TRUE)


MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
    replace_na(list( EPV_Faced = 0, EPV_Won = 0, EPV_Lost = 0)) 

#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerSeasonData

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonData <- MatchSummaryPLayerSeasonData

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerPassingSeasonData %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = receiving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerTouchesSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerShootingSeasonData %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerDefensiveSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)

########### for P90 data

MatchSummaryPLayerSeasonDataP90 <- MatchSummaryPLayerSeasonData %>%
  mutate(P90 = (minutes_played / 90),
         across(7:120, ~ round(.x / P90, 2)),
         Pass_Success = round((Successful_Passes / Attempted_Passes), 2),
         Aerial_Success = (Aerial_Won / Aerial_total),
         Duel_Success = (Ground_Duels_Won / Ground_Duels_Total),
         receiving_Suc = (Successful_Recieved / Passes_Recieved),
         across(c(Aerial_Success, Duel_Success, Pass_Success, receiving_Suc), ~ replace_na(.x, 0)))

#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonDataP90 <- MatchSummaryPLayerPassingSeasonDataP90 %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = receiving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonDataP90 <- MatchSummaryPLayerTouchesSeasonDataP90 %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonDataP90 <- MatchSummaryPLayerShootingSeasonDataP90 %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonDataP90 <- MatchSummaryPLayerDefensiveSeasonDataP90 %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)
```

## All Comp Stats {.tabset}

### Seasons Totals {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: Home player Passing table Season

SeasonSummaryPLayerPassingTableHome <- MatchSummaryPLayerPassingSeasonData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Possession Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "receiving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('receiving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHome

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: home player Touches table Season

SeasonSummaryPLayerTouchesTableHome <- 
  MatchSummaryPLayerTouchesSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Touches Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHome

```

```{r}
#| title: Shooting stats
#| results: asis


SeasonSummaryPLayerShootingTableHome <- MatchSummaryPLayerShootingSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Shooting Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHome
```

```{r}
#| title: Defensive stats
#| results: asis

SeasonSummaryPLayerDefensiveTableHome <- MatchSummaryPLayerDefensiveSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Defensive Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHome
```

### Season P90 {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: Home player Passing table Season P90

SeasonSummaryPLayerPassingTableHomeP90 <- MatchSummaryPLayerPassingSeasonDataP90 %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Possession P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "receiving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('receiving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHomeP90

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: home player Touches table Season P90

SeasonSummaryPLayerTouchesTableHomeP90 <- 
  MatchSummaryPLayerTouchesSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Touches P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHomeP90

```

```{r}
#| title: Shooting stats
#| results: asis
#| label: home player Shooting stats table Season P90

SeasonSummaryPLayerShootingTableHomeP90 <- MatchSummaryPLayerShootingSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Shooting P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHomeP90
```

```{r}
#| title: Defensive stats
#| results: asis
#| label: home player Defensive stats table Season P90

SeasonSummaryPLayerDefensiveTableHomeP90 <- MatchSummaryPLayerDefensiveSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Defensive P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHomeP90
```

# EPL

```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: EPL player Season stats tables setup

PlayerMatchRole <- EPLSeasonData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = if_else(`outcomeType/value` == 1, as.numeric(EPVvalue), 0)
  ) %>%
  group_by(TeamName, playerId, role, player_shirt, game_name) %>%
  summarise(
    minutes_played = min(minutes_played, na.rm = TRUE),
    across(
      c(Goals, TotalShots, OFShots, SoT = OTShots, Out_Box_Shots, Touches,
        Defensive_Third_Touches, Middle_Third_Touches, Final_Third_Touches,
        PK_Box_Touches, SixYard_Box_Touches, Attempted_Carries, Successful_Carries,
        Prog_Carries, Final_Third_Carries, Attempted_Passes, Successful_Passes,
        Long_Passes, Final_Third_Passes, PK_Box_Passes, Prog_Passes, Key_Passes,
        Assists, BCs, TeamEPV, xG, xGOT, MyxA, TeamxT, Aerial_total, Aerial_Won,
        Aerial_Lost, Ground_Duels_Total, Ground_Duels_Won, Ground_Duels_Lost,
        UnSuccessful_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
        Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
        Blocked_Shot, SixYard_Box_Shots, PK_Box_Shots, NPxG, UnSuccessful_Passes,
        Successful_Long_Passes, Corners, Short_Corners, Cross_Passes, Successful_Cross,
        UnSuccessful_Cross, Tackles_Total, Tackles_Won, Tackles_Lost, Fouls_Total,
        Fouls_Conceeded, Fouls_Received, Interceptions_Total, Recoverys_Total,
        Clearances_Total, Offside_Won, Offside_Lost, Carries_distance,
        Successful_Carries_Distance, Prog_Carries_Distance),
      ~ sum(.x, na.rm = TRUE)
    ),
    .groups = "drop"
  )

MatchSummaryPLayerSeasonData <- PlayerMatchRole %>%
  group_by(TeamName, playerId, role, player_shirt) %>%
  summarise(
    Matches_Played = n_distinct(game_name),
    minutes_played = sum(minutes_played, na.rm = TRUE),

    across(
      -c(game_name, Matches_Played, minutes_played),
      ~ sum(.x, na.rm = TRUE)
    ),

    .groups = "drop"
  )

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  group_by(TeamName) %>%
  mutate(
    Team_TotalTouches  = sum(Touches, na.rm = TRUE),
    Team_TotalEPV      = sum(TeamEPV, na.rm = TRUE),
    Team_TotalxG       = sum(xG, na.rm = TRUE),
    Team_TotalPasses   = sum(Attempted_Passes, na.rm = TRUE),
    Team_TotalDuels    = sum(Ground_Duels_Total, na.rm = TRUE),
    Team_TotalAerials  = sum(Aerial_total, na.rm = TRUE),
    Team_TotalShots    = sum(TotalShots, na.rm = TRUE),

    Possession   = round(Touches / Team_TotalTouches, 2),
    Pass_Success = round(Successful_Passes / Attempted_Passes, 2),
    Aerial_Success = Aerial_Won / Aerial_total,
    Duel_Success   = Ground_Duels_Won / Ground_Duels_Total,

    On_Ball_Time = round(InPlayTime * Possession, 2),

    Team_EPV_P    = round(TeamEPV / Team_TotalEPV, 2),
    Team_xG_P     = round(xG / Team_TotalxG, 2),
    Team_Duels_P  = round(Ground_Duels_Total / Team_TotalDuels, 2),
    Team_Aerial_P = round(Aerial_total / Team_TotalAerials, 2),
    Team_Passes_P = round(Attempted_Passes / Team_TotalPasses, 2),
    Team_Shots_P  = round(TotalShots / Team_TotalShots, 2)
  ) %>%
  mutate(
    across(c(Aerial_Success, Duel_Success, Pass_Success), ~ replace_na(.x, 0))
  ) %>%
  ungroup()

MD_adv_passing <- EPLSeasonData 
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "playerId", new_names = "Receiver", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "TeamName", new_names = "Receiver_Team", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "player_shirt", new_names = "Receiver_shirt", len = 1, up = TRUE)

MD_adv_passing <- MD_adv_passing %>%
  filter(Attempted_Passes == 1) %>% 
  select(Receiver, Receiver_shirt, Passer_Team = TeamName, Receiver_Team, minutes_played, Attempted_Passes, Successful_Passes, Key_Passes, Prog_Passes, EPV = EPVvalue) 

MD_adv_passing <- MD_adv_passing %>%
  group_by(Receiver, Receiver_Team) %>%
    summarise(Receiver_shirt = first(Receiver_shirt), Passes_Recieved = sum(Attempted_Passes), Successful_Recieved = sum(Successful_Passes), Key_Passes_Recieved = sum(Key_Passes), Prog_Passes_Recieved = sum(Prog_Passes), EPV = sum(EPV))  %>% 
  #na.omit() %>%
  mutate(receiving_Suc = (Successful_Recieved / Passes_Recieved)) %>%
  replace_na(list(receiving_Suc = 0)) %>%
  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, EPV_Recieved = EPV, receiving_Suc)

#data load check for data to be converted to number
#MatchdayTablePass <- MD_passing_values #xt xa from fbref
MatchdayTableAdvPass <- MD_adv_passing

# add all data together
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(MatchdayTableAdvPass, by = c("TeamName" = "Team", "player_shirt" = "Shirt", "playerId" = "Receiver"), copy = TRUE) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

#work out detailed passing, and touches variables
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  mutate('xG/Shot' =  xG/TotalShots,
  'Shot Accuracy' = SoT/TotalShots,
  'Shot Quality' = (xGOT - xG)/xG) %>%
  mutate(`% F 3rd Carries` = Final_Third_Carries / Successful_Carries) %>%
  mutate(`% P Carries` = Prog_Carries / Successful_Carries) %>%
  mutate(`% Carries D Prog` = Prog_Carries_Distance / Successful_Carries_Distance) %>%
  mutate(`Def Third Touches / Min` = Defensive_Third_Touches / minutes_played) %>%
  mutate(`Mid Third Touches / Min` = Middle_Third_Touches / minutes_played) %>%
  mutate(`F 3rd Touches / Min` = Final_Third_Touches / minutes_played) %>%
  mutate(`PK Box Touches / Min` = PK_Box_Touches / minutes_played) %>%
  mutate(`% T D Third` = Defensive_Third_Touches / Touches) %>%
  mutate(`% T M Third` = Middle_Third_Touches / Touches) %>%
  mutate(`% T F 3rd` = Final_Third_Touches / Touches) %>%
  mutate(`% T PK Box` = PK_Box_Touches / Touches) %>%
  mutate(`T / Min` = Touches / minutes_played) %>%
  mutate(Failed_Pass = round(Attempted_Passes - Successful_Passes, 2),
         Failed_Cross = round(Cross_Passes - Successful_Cross, 2),
         Failed_Dribble = round(Dribbles_Total - Dribbles_Won, 2),
         Poss_Gained = round(Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost), 2),
         Poss_Lost = (Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost),
         Posession_Control = (Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost) - (Mis_Control + Dispossessed_Total + UnSuccessful_Passes + UnSuccessful_Cross + Dribbles_Lost  + OFShots + Blocked_Shot + Offside_Lost)),) %>%
  mutate_all(~ ifelse(is.na(.), 0, .))

DefEPVData <- EPLSeasonData %>%
  filter(Corners == 0,
         Short_Corners == 0,
         FreeKicks == 0,
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 107,
           `type/value` == 1 |
           `type/value` == 2 | 
           `type/value` == 3 |
           `type/value` == 4 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "EPV_Def", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(TeamName, playerId, EPVvalue, Defensive_Action, `outcomeType/value`, EPV_Def, role) %>%
  mutate(EPV_Faced = (EPVvalue + EPV_Def),
    Successful_Def_EPV = ifelse(`outcomeType/value` == 1, paste0(EPV_Faced), 0),
         Unsuccessful_Def_EPV = ifelse(`outcomeType/value` == 0, paste0(EPV_Faced), 0), 
         Successful_Def_EPV = as.numeric(Successful_Def_EPV),
         Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

DefEPVData <- DefEPVData %>%
    group_by(playerId, role, TeamName) %>% 
  summarise(EPV_Faced = sum(EPV_Faced),
            EPV_Won = sum(Successful_Def_EPV/EPV_Faced), 
            EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .)) 

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(DefEPVData, by = c('playerId' = 'playerId', 'TeamName' = 'TeamName', 'role' = 'role'), copy = TRUE)


MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
    replace_na(list( EPV_Faced = 0, EPV_Won = 0, EPV_Lost = 0)) 

#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerSeasonData

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonData <- MatchSummaryPLayerSeasonData

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerPassingSeasonData %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = receiving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerTouchesSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerShootingSeasonData %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerDefensiveSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)

########### for P90 data

MatchSummaryPLayerSeasonDataP90 <- MatchSummaryPLayerSeasonData %>%
  mutate(P90 = (minutes_played / 90),
         across(7:120, ~ round(.x / P90, 2)),
         Pass_Success = round((Successful_Passes / Attempted_Passes), 2),
         Aerial_Success = (Aerial_Won / Aerial_total),
         Duel_Success = (Ground_Duels_Won / Ground_Duels_Total),
         receiving_Suc = (Successful_Recieved / Passes_Recieved),
         across(c(Aerial_Success, Duel_Success, Pass_Success, receiving_Suc), ~ replace_na(.x, 0)))

#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonDataP90 <- MatchSummaryPLayerPassingSeasonDataP90 %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = receiving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonDataP90 <- MatchSummaryPLayerTouchesSeasonDataP90 %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonDataP90 <- MatchSummaryPLayerShootingSeasonDataP90 %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonDataP90 <- MatchSummaryPLayerDefensiveSeasonDataP90 %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)
```

## EPL Stats {.tabset}

### Seasons Totals {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: EPL Home player Passing table Season

SeasonSummaryPLayerPassingTableHome <- MatchSummaryPLayerPassingSeasonData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Possession Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "receiving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('receiving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHome

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: EPL home player Touches table Season

SeasonSummaryPLayerTouchesTableHome <- 
  MatchSummaryPLayerTouchesSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Touches Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHome

```

```{r}
#| title: Shooting stats
#| label: EPL Shooting stats
#| results: asis


SeasonSummaryPLayerShootingTableHome <- MatchSummaryPLayerShootingSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Shooting Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHome
```

```{r}
#| title: Defensive stats
#| label: EPL Defensive stats
#| results: asis

SeasonSummaryPLayerDefensiveTableHome <- MatchSummaryPLayerDefensiveSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Defensive Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHome
```

### Season P90 {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: EPL Home player Passing table Season P90

SeasonSummaryPLayerPassingTableHomeP90 <- MatchSummaryPLayerPassingSeasonDataP90 %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Possession P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "receiving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('receiving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHomeP90

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: EPL home player Touches table Season P90

SeasonSummaryPLayerTouchesTableHomeP90 <- 
  MatchSummaryPLayerTouchesSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Touches P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHomeP90

```

```{r}
#| title: Shooting stats
#| results: asis
#| label: EPL home player Shooting stats table Season P90

SeasonSummaryPLayerShootingTableHomeP90 <- MatchSummaryPLayerShootingSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Shooting P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHomeP90
```

```{r}
#| title: Defensive stats
#| results: asis
#| label: EPL home player Defensive stats table Season P90

SeasonSummaryPLayerDefensiveTableHomeP90 <- MatchSummaryPLayerDefensiveSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Defensive P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHomeP90
```

# CL

```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: CL player Season stats tables setup

PlayerMatchRole <- CLSeasonData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = if_else(`outcomeType/value` == 1, as.numeric(EPVvalue), 0)
  ) %>%
  group_by(TeamName, playerId, role, player_shirt, game_name) %>%
  summarise(
    minutes_played = min(minutes_played, na.rm = TRUE),
    across(
      c(Goals, TotalShots, OFShots, SoT = OTShots, Out_Box_Shots, Touches,
        Defensive_Third_Touches, Middle_Third_Touches, Final_Third_Touches,
        PK_Box_Touches, SixYard_Box_Touches, Attempted_Carries, Successful_Carries,
        Prog_Carries, Final_Third_Carries, Attempted_Passes, Successful_Passes,
        Long_Passes, Final_Third_Passes, PK_Box_Passes, Prog_Passes, Key_Passes,
        Assists, BCs, TeamEPV, xG, xGOT, MyxA, TeamxT, Aerial_total, Aerial_Won,
        Aerial_Lost, Ground_Duels_Total, Ground_Duels_Won, Ground_Duels_Lost,
        UnSuccessful_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
        Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
        Blocked_Shot, SixYard_Box_Shots, PK_Box_Shots, NPxG, UnSuccessful_Passes,
        Successful_Long_Passes, Corners, Short_Corners, Cross_Passes, Successful_Cross,
        UnSuccessful_Cross, Tackles_Total, Tackles_Won, Tackles_Lost, Fouls_Total,
        Fouls_Conceeded, Fouls_Received, Interceptions_Total, Recoverys_Total,
        Clearances_Total, Offside_Won, Offside_Lost, Carries_distance,
        Successful_Carries_Distance, Prog_Carries_Distance),
      ~ sum(.x, na.rm = TRUE)
    ),
    .groups = "drop"
  )

MatchSummaryPLayerSeasonData <- PlayerMatchRole %>%
  group_by(TeamName, playerId, role, player_shirt) %>%
  summarise(
    Matches_Played = n_distinct(game_name),
    minutes_played = sum(minutes_played, na.rm = TRUE),

    across(
      -c(game_name, Matches_Played, minutes_played),
      ~ sum(.x, na.rm = TRUE)
    ),

    .groups = "drop"
  )

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  group_by(TeamName) %>%
  mutate(
    Team_TotalTouches  = sum(Touches, na.rm = TRUE),
    Team_TotalEPV      = sum(TeamEPV, na.rm = TRUE),
    Team_TotalxG       = sum(xG, na.rm = TRUE),
    Team_TotalPasses   = sum(Attempted_Passes, na.rm = TRUE),
    Team_TotalDuels    = sum(Ground_Duels_Total, na.rm = TRUE),
    Team_TotalAerials  = sum(Aerial_total, na.rm = TRUE),
    Team_TotalShots    = sum(TotalShots, na.rm = TRUE),

    Possession   = round(Touches / Team_TotalTouches, 2),
    Pass_Success = round(Successful_Passes / Attempted_Passes, 2),
    Aerial_Success = Aerial_Won / Aerial_total,
    Duel_Success   = Ground_Duels_Won / Ground_Duels_Total,

    On_Ball_Time = round(InPlayTime * Possession, 2),

    Team_EPV_P    = round(TeamEPV / Team_TotalEPV, 2),
    Team_xG_P     = round(xG / Team_TotalxG, 2),
    Team_Duels_P  = round(Ground_Duels_Total / Team_TotalDuels, 2),
    Team_Aerial_P = round(Aerial_total / Team_TotalAerials, 2),
    Team_Passes_P = round(Attempted_Passes / Team_TotalPasses, 2),
    Team_Shots_P  = round(TotalShots / Team_TotalShots, 2)
  ) %>%
  mutate(
    across(c(Aerial_Success, Duel_Success, Pass_Success), ~ replace_na(.x, 0))
  ) %>%
  ungroup()

MD_adv_passing <- CLSeasonData 
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "playerId", new_names = "Receiver", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "TeamName", new_names = "Receiver_Team", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "player_shirt", new_names = "Receiver_shirt", len = 1, up = TRUE)

MD_adv_passing <- MD_adv_passing %>%
  filter(Attempted_Passes == 1) %>% 
  select(Receiver, Receiver_shirt, Passer_Team = TeamName, Receiver_Team, minutes_played, Attempted_Passes, Successful_Passes, Key_Passes, Prog_Passes, EPV = EPVvalue) 

MD_adv_passing <- MD_adv_passing %>%
  group_by(Receiver, Receiver_Team) %>%
    summarise(Receiver_shirt = first(Receiver_shirt), Passes_Recieved = sum(Attempted_Passes), Successful_Recieved = sum(Successful_Passes), Key_Passes_Recieved = sum(Key_Passes), Prog_Passes_Recieved = sum(Prog_Passes), EPV = sum(EPV))  %>% 
  #na.omit() %>%
  mutate(receiving_Suc = (Successful_Recieved / Passes_Recieved)) %>%
  replace_na(list(receiving_Suc = 0)) %>%
  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, EPV_Recieved = EPV, receiving_Suc)

#data load check for data to be converted to number
#MatchdayTablePass <- MD_passing_values #xt xa from fbref
MatchdayTableAdvPass <- MD_adv_passing

# add all data together
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(MatchdayTableAdvPass, by = c("TeamName" = "Team", "player_shirt" = "Shirt", "playerId" = "Receiver"), copy = TRUE) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

#work out detailed passing, and touches variables
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  mutate('xG/Shot' =  xG/TotalShots,
  'Shot Accuracy' = SoT/TotalShots,
  'Shot Quality' = (xGOT - xG)/xG) %>%
  mutate(`% F 3rd Carries` = Final_Third_Carries / Successful_Carries) %>%
  mutate(`% P Carries` = Prog_Carries / Successful_Carries) %>%
  mutate(`% Carries D Prog` = Prog_Carries_Distance / Successful_Carries_Distance) %>%
  mutate(`Def Third Touches / Min` = Defensive_Third_Touches / minutes_played) %>%
  mutate(`Mid Third Touches / Min` = Middle_Third_Touches / minutes_played) %>%
  mutate(`F 3rd Touches / Min` = Final_Third_Touches / minutes_played) %>%
  mutate(`PK Box Touches / Min` = PK_Box_Touches / minutes_played) %>%
  mutate(`% T D Third` = Defensive_Third_Touches / Touches) %>%
  mutate(`% T M Third` = Middle_Third_Touches / Touches) %>%
  mutate(`% T F 3rd` = Final_Third_Touches / Touches) %>%
  mutate(`% T PK Box` = PK_Box_Touches / Touches) %>%
  mutate(`T / Min` = Touches / minutes_played) %>%
  mutate(Failed_Pass = round(Attempted_Passes - Successful_Passes, 2),
         Failed_Cross = round(Cross_Passes - Successful_Cross, 2),
         Failed_Dribble = round(Dribbles_Total - Dribbles_Won, 2),
         Poss_Gained = round(Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost), 2),
         Poss_Lost = (Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost),
         Posession_Control = (Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost) - (Mis_Control + Dispossessed_Total + UnSuccessful_Passes + UnSuccessful_Cross + Dribbles_Lost  + OFShots + Blocked_Shot + Offside_Lost)),) %>%
  mutate_all(~ ifelse(is.na(.), 0, .))

DefEPVData <- CLSeasonData %>%
  filter(Corners == 0,
         Short_Corners == 0,
         FreeKicks == 0,
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 107,
           `type/value` == 1 |
           `type/value` == 2 | 
           `type/value` == 3 |
           `type/value` == 4 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "EPV_Def", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(TeamName, playerId, EPVvalue, Defensive_Action, `outcomeType/value`, EPV_Def, role) %>%
  mutate(EPV_Faced = (EPVvalue + EPV_Def),
    Successful_Def_EPV = ifelse(`outcomeType/value` == 1, paste0(EPV_Faced), 0),
         Unsuccessful_Def_EPV = ifelse(`outcomeType/value` == 0, paste0(EPV_Faced), 0), 
         Successful_Def_EPV = as.numeric(Successful_Def_EPV),
         Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

DefEPVData <- DefEPVData %>%
    group_by(playerId, role, TeamName) %>% 
  summarise(EPV_Faced = sum(EPV_Faced),
            EPV_Won = sum(Successful_Def_EPV/EPV_Faced), 
            EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .)) 

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(DefEPVData, by = c('playerId' = 'playerId', 'TeamName' = 'TeamName', 'role' = 'role'), copy = TRUE)


MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
    replace_na(list( EPV_Faced = 0, EPV_Won = 0, EPV_Lost = 0)) 

#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerSeasonData

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonData <- MatchSummaryPLayerSeasonData

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerPassingSeasonData %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = receiving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerTouchesSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerShootingSeasonData %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerDefensiveSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)

########### for P90 data

MatchSummaryPLayerSeasonDataP90 <- MatchSummaryPLayerSeasonData %>%
  mutate(P90 = (minutes_played / 90),
         across(7:120, ~ round(.x / P90, 2)),
         Pass_Success = round((Successful_Passes / Attempted_Passes), 2),
         Aerial_Success = (Aerial_Won / Aerial_total),
         Duel_Success = (Ground_Duels_Won / Ground_Duels_Total),
         receiving_Suc = (Successful_Recieved / Passes_Recieved),
         across(c(Aerial_Success, Duel_Success, Pass_Success, receiving_Suc), ~ replace_na(.x, 0)))

#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonDataP90 <- MatchSummaryPLayerSeasonDataP90

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonDataP90 <- MatchSummaryPLayerPassingSeasonDataP90 %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = receiving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonDataP90 <- MatchSummaryPLayerTouchesSeasonDataP90 %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonDataP90 <- MatchSummaryPLayerShootingSeasonDataP90 %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonDataP90 <- MatchSummaryPLayerDefensiveSeasonDataP90 %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)
```

## CL Stats {.tabset}

### Seasons Totals {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: CL Home player Passing table Season

SeasonSummaryPLayerPassingTableHome <- MatchSummaryPLayerPassingSeasonData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Possession Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "receiving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('receiving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHome

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: CL home player Touches table Season

SeasonSummaryPLayerTouchesTableHome <- 
  MatchSummaryPLayerTouchesSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Touches Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHome

```

```{r}
#| title: Shooting stats
#| label: CL Shooting stats
#| results: asis


SeasonSummaryPLayerShootingTableHome <- MatchSummaryPLayerShootingSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Shooting Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHome
```

```{r}
#| title: Defensive stats
#| label: CL Defensive stats
#| results: asis

SeasonSummaryPLayerDefensiveTableHome <- MatchSummaryPLayerDefensiveSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Defensive Totals"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHome
```

### Season P90 {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: CL Home player Passing table Season P90

SeasonSummaryPLayerPassingTableHomeP90 <- MatchSummaryPLayerPassingSeasonDataP90 %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Possession P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "receiving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('receiving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHomeP90

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: CL home player Touches table Season P90

SeasonSummaryPLayerTouchesTableHomeP90 <- 
  MatchSummaryPLayerTouchesSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Touches P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHomeP90

```

```{r}
#| title: Shooting stats
#| results: asis
#| label: CL home player Shooting stats table Season P90

SeasonSummaryPLayerShootingTableHomeP90 <- MatchSummaryPLayerShootingSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Shooting P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHomeP90
```

```{r}
#| title: Defensive stats
#| results: asis
#| label: CL home player Defensive stats table Season P90

SeasonSummaryPLayerDefensiveTableHomeP90 <- MatchSummaryPLayerDefensiveSeasonDataP90 %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Season Defensive P90"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#DBDBDB",
    row_group.background.color = Color_Home,
    stub.background.color = "#DBDBDB",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#DBDBDB",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHomeP90
```
